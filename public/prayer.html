<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>代禱牆</title>
  <link rel="stylesheet" href="css/styles.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
  <!-- 導航欄容器 -->
  <div id="navbar-container"></div>

  <!-- 主要內容 -->
  <div class="container" style="margin-top: 60px;">
    <div class="header-section">
      <h1>代禱牆 - <span id="current-hall">選擇會所...</span></h1>
      <!-- 提示圖標 -->
      <div class="hint-icon">ℹ️
        <div class="hint-content">
          <p>
          ✅：可以前來<br>
          ❌：無法前來<br>
          ❓：已邀約但未回覆<br>
          #️⃣：尚未邀約</p>
        </div>
      </div>
    </div>
    <div class="mb-3">
      <button id="hall-h3-new" class="btn btn-primary me-2">H3（新生）</button>
      <button id="hall-h3-peace" class="btn btn-primary me-2">H3（和平）</button>
      <button id="hall-h3-english" class="btn btn-primary me-2">H3（英語）</button>
      <button id="hall-h62" class="btn btn-primary me-2">H62</button>
      <button id="hall-h71" class="btn btn-primary me-2">H71</button>
      <button id="hall-h82" class="btn btn-primary me-2">H82</button>
      <button id="hall-h103" class="btn btn-primary me-2">H103</button>
    </div>

    <div id="prayer-container"></div>
  </div>

  <!-- Toast 提示容器 -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="submit-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto">提交狀態</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body"></div>
    </div>
  </div>

  <!-- Modal 表單（新增代禱事項） -->
  <div class="modal fade" id="prayerModal" tabindex="-1" aria-labelledby="prayerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="prayerModalLabel">新增</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="prayerForm">
            <div class="mb-3">
              <label for="prayer-content" class="form-label">姓名</label>
              <input type="text" class="form-control" id="prayer-content" required>
            </div>
            <div class="mb-3">
              <label for="prayer-status" class="form-label">邀約狀態</label>
              <select class="form-select" id="prayer-status" required>
                <option value="✅">✅</option>
                <option value="❌">❌</option>
                <option value="❓">❓</option>
                <option value="#️⃣">#️⃣</option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary">提交</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal 表單（顯示統計數據） -->
  <div class="modal fade" id="statsModal" tabindex="-1" aria-labelledby="statsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="statsModalLabel">統計數據</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <table id="stats-modal-table" class="table table-striped table-bordered">
            <thead>
              <tr>
                <th>狀態</th>
                <th>人數</th>
              </tr>
            </thead>
            <tbody id="stats-modal-body"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- 主浮動按鈕和次級按鈕 -->
  <div id="main-floating-button" class="btn btn-primary" style="position: fixed; bottom: 20px; right: 20px;"><span>☰</span></div>
  <div id="sub-buttons" style="position: fixed; bottom: 20px; right: 20px; display: none; flex-direction: column; gap: 10px; z-index: 1000;">
    <button id="sub-add-button" class="btn btn-primary" style="width: 120px;">新增</button>
    <button id="sub-stats-button" class="btn btn-primary" style="width: 120px;">統計</button>
  </div>

  <!-- 腳本 -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let currentHall = 'hall-h3-new'; // 默認選擇 H71
    let prayerData = {};

    // Toast 初始化
    const toastEl = document.getElementById('submit-toast');
    const toast = new bootstrap.Toast(toastEl);

    // 會所按鈕事件
    document.getElementById('hall-h3-new').addEventListener('click', () => selectHall('hall-h3-new'));
    document.getElementById('hall-h3-peace').addEventListener('click', () => selectHall('hall-h3-peace'));
    document.getElementById('hall-h3-english').addEventListener('click', () => selectHall('hall-h3-english'));
    document.getElementById('hall-h62').addEventListener('click', () => selectHall('hall-h62'));
    document.getElementById('hall-h71').addEventListener('click', () => selectHall('hall-h71'));
    document.getElementById('hall-h82').addEventListener('click', () => selectHall('hall-h82'));
    document.getElementById('hall-h103').addEventListener('click', () => selectHall('hall-h103'));

    function selectHall(hallId) {
      currentHall = hallId;
      const hallMap = {
        'hall-h3-new': 'H3（新生）',
        'hall-h3-peace': 'H3（和平）',
        'hall-h3-english': 'H3（英語）',
        'hall-h62': 'H62',
        'hall-h71': 'H71',
        'hall-h82': 'H82',
        'hall-h103': 'H103'
      };
      document.getElementById('current-hall').textContent = hallMap[hallId];
      fetchPrayerData();
      fetchPrayerStats(); // 切換會所時更新統計數據
    }

    // 載入導航欄（可重用 hall71 的 navbar.html）
    function loadNavbar() {
      fetch('navbar.html')
        .then(response => response.text())
        .then(data => {
          document.getElementById('navbar-container').innerHTML = data;
          // 載入完成後隱藏日期選單和搜尋框
          hideDateRangeAndSearch();
        })
        .catch(error => console.error('Error loading navbar:', error));
    }

    // 隱藏日期選單和搜尋框
    function hideDateRangeAndSearch() {
      const dateRangeSelect = document.getElementById('date-range');
      const searchInput = document.getElementById('search-input');
      const dateRangeContainer = document.getElementById('date-range-container');

      if (dateRangeSelect) dateRangeSelect.style.display = 'none';
      if (searchInput) searchInput.style.display = 'none';
      if (dateRangeContainer) dateRangeContainer.style.display = 'none';
    }
    loadNavbar();

    // 獲取代禱數據
    function fetchPrayerData() {
      fetch(`/getPrayerData?hall=${currentHall}`)
        .then(response => response.json())
        .then(data => {
          prayerData = data;
          renderPrayerData();
        })
        .catch(err => {
          console.error('獲取代禱數據時出錯:', err);
          showToast('獲取數據時出錯，請稍後再試', 'danger');
        });
    }

    // 獲取統計數據
    function fetchPrayerStats() {
      fetch(`/getPrayerStats?hall=${currentHall}`)
        .then(response => response.json())
        .then(stats => {
          renderModalStats(stats); // 僅更新 Modal 中的統計數據
        })
        .catch(err => {
          console.error('獲取統計數據時出錯:', err);
          showToast('獲取統計數據時出錯，請稍後再試', 'danger');
        });
    }

    function renderPrayerData() {
      const prayerContainer = document.getElementById('prayer-container');
      prayerContainer.innerHTML = '';
      for (let id in prayerData) {
        const prayer = prayerData[id];
        const prayerDiv = document.createElement('div');
        prayerDiv.classList.add('prayer-item');
        prayerDiv.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <span>${prayer.content}</span>
            <select class="form-select status-select" data-id="${id}" style="width: auto;">
              <option value="">-- 選擇狀態 --</option>
              <option value="#️⃣" ${prayer.status === '#️⃣' ? 'selected' : ''}>#️⃣</option>
              <option value="✅" ${prayer.status === '✅' ? 'selected' : ''}>✅</option>
              <option value="❌" ${prayer.status === '❌' ? 'selected' : ''}>❌</option>
              <option value="❓" ${prayer.status === '❓' ? 'selected' : ''}>❓</option>
            </select>
            <button class="btn btn-danger btn-sm delete-prayer" data-id="${id}">清除</button>
          </div>
        `;
        prayerContainer.appendChild(prayerDiv);
      }

      // 綁定即時更新事件
      document.querySelectorAll('.status-select').forEach(select => {
        select.addEventListener('change', (e) => updatePrayerStatus(e, select.dataset.id));
      });
      document.querySelectorAll('.delete-prayer').forEach(button => {
        button.addEventListener('click', deletePrayer);
      });
    }

    function renderModalStats(stats) {
      const statsModalBody = document.getElementById('stats-modal-body');
      statsModalBody.innerHTML = ''; // 清空現有內容

      // 渲染每種狀態的人數
      for (const [status, count] of Object.entries(stats)) {
        if (status !== 'total') { // 排除 total 字段，只顯示具體狀態
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${status}</td>
            <td>${count}</td>
          `;
          statsModalBody.appendChild(row);
        }
      }

      // 渲染總數
      const totalRow = document.createElement('tr');
      totalRow.innerHTML = `
        <td><strong>總數</strong></td>
        <td><strong>${stats.total}</strong></td>
      `;
      statsModalBody.appendChild(totalRow);
    }

    function updatePrayerStatus(e, id) {
      const status = e.target.value;
      if (!status) { // 如果選擇空白選項，不發送更新請求，但保留顯示
        return;
      }
      fetch('/updatePrayerStatus', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id, status, hall: currentHall }),
      })
      .then(response => response.json())
      .then(data => {
        showToast('狀態更新成功', 'success');
        fetchPrayerData(); // 刷新數據以確保 UI 同步
        fetchPrayerStats(); // 更新統計數據
      })
      .catch(error => {
        console.error('更新狀態失敗:', error);
        showToast('更新狀態失敗，請稍後再試', 'danger');
      });
    }

    function deletePrayer(e) {
      if (confirm('確定要清除此代禱事項嗎？')) {
        const id = e.target.dataset.id;
        fetch('/deletePrayer', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id, hall: currentHall }),
        })
        .then(response => response.json())
        .then(data => {
          showToast('代禱事項清除成功', 'success');
          fetchPrayerData();
          fetchPrayerStats(); // 更新統計數據
        })
        .catch(error => {
          console.error('清除失敗:', error);
          showToast('清除失敗，請稍後再試', 'danger');
        });
      }
    }

    // 主浮動按鈕和次級按鈕相關邏輯
    const mainFloatingButton = document.getElementById('main-floating-button');
    const subButtons = document.getElementById('sub-buttons');
    let isSubButtonsVisible = false;

    mainFloatingButton.addEventListener('click', function(e) {
      e.stopPropagation();
      isSubButtonsVisible = !isSubButtonsVisible;
      subButtons.style.display = isSubButtonsVisible ? 'flex' : 'none';
      mainFloatingButton.style.display = isSubButtonsVisible ? 'none' : 'flex';
    });

    // 次級按鈕事件
    document.getElementById('sub-add-button').addEventListener('click', function(e) {
      e.stopPropagation();
      document.getElementById('prayer-content').value = '';
      document.getElementById('prayer-status').value = ''; // 設置為空白選項
      const modal = new bootstrap.Modal(document.getElementById('prayerModal'));
      modal.show();
      hideSubButtons();
    });

    document.getElementById('sub-stats-button').addEventListener('click', function(e) {
      e.stopPropagation();
      const modal = new bootstrap.Modal(document.getElementById('statsModal'));
      modal.show();
      hideSubButtons();
    });

    // 隱藏次級按鈕（點擊其他地方時）
    document.addEventListener('click', function(e) {
      if (isSubButtonsVisible && !subButtons.contains(e.target) && e.target !== mainFloatingButton) {
        hideSubButtons();
      }
    });

    function hideSubButtons() {
      subButtons.style.display = 'none';
      mainFloatingButton.style.display = 'flex';
      isSubButtonsVisible = false;
    }

    document.getElementById('prayerForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const content = document.getElementById('prayer-content').value;
      const status = document.getElementById('prayer-status').value;

      if (!status) { // 如果狀態為空白，提示用戶選擇狀態
        showToast('請選擇邀約狀態', 'warning');
        return;
      }

      fetch('/addPrayer', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content, status, hall: currentHall }),
      })
      .then(response => response.json())
      .then(data => {
        showToast('新增成功', 'success');
        bootstrap.Modal.getInstance(document.getElementById('prayerModal')).hide();
        fetchPrayerData();
        fetchPrayerStats(); // 更新統計數據
      })
      .catch(error => {
        console.error('操作失敗:', error);
        showToast('操作失敗，請稍後再試', 'danger');
      });
    });

    function showToast(message, type) {
      const toastBody = toastEl.querySelector('.toast-body');
      toastBody.textContent = message;
      toastEl.classList.remove('text-bg-success', 'text-bg-danger', 'text-bg-warning');
      toastEl.classList.add(`text-bg-${type}`);
      toast.show();
    }

    // 初始載入數據
    selectHall('hall-h3-new'); // 默認選擇 H71
  </script>
</body>
</html>