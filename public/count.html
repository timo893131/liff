<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>統計總表</title>
  <link rel="stylesheet" href="css/styles.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
  <!-- 導航欄容器 -->
  <div id="navbar-container"></div>

  <!-- 主要內容 -->
  <div class="container" style="margin-top: 60px;">
    <div class="header-section">
      <h1>各會所統計總表 - <span id="current-date">日期載入中...</span></h1>
    </div>
    <div id="stats-container">
      <h3>統計數據</h3>
      <table id="total-stats-table" class="table table-bordered">
        <thead>
          <tr>
            <th>會所</th>
            <th>總數</th>
            <th>有主日</th>
            <th>答應主日</th>
            <th>有小排</th>
            <th>家聚會(讀經)</th>
            <th>家聚會(讀其他、福音餐廳)</th>
            <th>有聯絡有回應</th>
            <th>有聯絡未回應</th>
          </tr>
        </thead>
        <tbody id="total-stats-body"></tbody>
      </table>
    </div>
  </div>

  <!-- 懸浮按鈕（可選，根據需求可加入或移除） -->
  <div id="floating-button-container"></div>

  <!-- Toast 提示容器 -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="submit-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto">提交狀態</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Toast 初始化
    const toastEl = document.getElementById('submit-toast');
    const toast = new bootstrap.Toast(toastEl);
    let dateRanges = []; // 儲存動態日期範圍

    // 加載導航欄
    function loadNavbar() {
      fetch('navbar.html')
        .then(response => response.text())
        .then(data => {
          document.getElementById('navbar-container').innerHTML = data;
          fetchDateRanges().then(() => {
            const dateRangeSelect = document.getElementById('date-range');
            if (dateRangeSelect) {
              populateDateRangeSelect(dateRangeSelect);
              dateRangeSelect.addEventListener('change', function() {
                fetchTotalStats(this.value);
              });
            }
            setDefaultDateRange();
          });
        })
        .catch(error => console.error('Error loading navbar:', error));
    }
    loadNavbar();

    // 從後端動態獲取日期範圍
    async function fetchDateRanges() {
      try {
        const response = await fetch('/getDateRanges');
        if (!response.ok) {
          throw new Error(`伺服器錯誤 (${response.status})`);
        }
        const data = await response.json();
        dateRanges = (data.dateRanges || []).map((range, index) => {
          const [start, end] = range.split('~');
          const currentYear = new Date().getFullYear(); // 假設使用當前年份 (2025)
          return {
            range: range, // e.g., "02/17~02/23"
            start: new Date(`${currentYear}-${start}`), // e.g., 2025-02-17
            end: new Date(`${currentYear}-${end}`),     // e.g., 2025-02-23
            code: String.fromCharCode(71 + index)      // G, H, I, ...
          };
        });
        if (dateRanges.length === 0) {
          throw new Error('未收到日期範圍數據');
        }
      } catch (error) {
        console.error('Error fetching date ranges:', error);
        dateRanges = [];
        showToast('無法載入日期範圍，請檢查伺服器連接', 'danger');
      }
    }

    // 填充日期下拉選單
    function populateDateRangeSelect(selectElement) {
      selectElement.innerHTML = '<option value="" disabled selected>請選擇日期範圍</option>';
      dateRanges.forEach((date) => {
        const option = document.createElement('option');
        option.value = date.code; // G, H, I, ...
        option.textContent = date.range; // 顯示後端返回的日期範圍字符串
        selectElement.appendChild(option);
      });
    }

    // 設置默認日期
    function setDefaultDateRange() {
      const dateRangeSelect = document.getElementById('date-range');
      if (dateRangeSelect && dateRanges.length > 0) {
        const defaultDate = getCurrentDateRangeDynamic();
        dateRangeSelect.value = defaultDate || dateRanges[0].code; // 若無匹配則用第一個
        fetchTotalStats(dateRangeSelect.value);
      } else {
        showToast('日期範圍尚未載入，請稍後再試', 'warning');
      }
    }

    // 動態獲取當前日期範圍
    function getCurrentDateRangeDynamic() {
      const currentDate = new Date();
      for (const range of dateRanges) {
        if (currentDate >= range.start && currentDate <= range.end) {
          return range.code; // 返回對應的代碼 (G, H, I...)
        }
      }
      return null; // 如果當前日期不在任何範圍內，返回 null
    }

    // 格式化日期範圍顯示
    function formatDateRange(dateCode) {
      const range = dateRanges.find(r => r.code === dateCode);
      return range ? range.range : '日期載入中...'; // 使用後端返回的日期範圍字符串
    }

    // 獲取並顯示所有會所的統計數據
    async function fetchTotalStats(selectedDate) {
      const halls = ['hall3', 'hall3E', 'hall62', 'hall71', 'hall82', 'hall103'];
      const statsData = {};
      const options = ['有主日', '答應主日', '有小排', '家聚會(讀經)', '家聚會(讀其他、福音餐廳)', '有聯絡有回應', '有聯絡未回應'];

      try {
        // 並行獲取每個會所的統計數據
        const statsPromises = halls.map(hall => 
          fetch(`/getStats?selectedDate=${selectedDate}&hall=${hall}`)
            .then(response => response.json())
            .catch(error => {
              console.error(`Error fetching stats for ${hall}:`, error);
              return { '總數': 0 }; // 預設值，處理錯誤情況
            })
        );

        const statsResults = await Promise.all(statsPromises);

        // 合併各會所的統計數據
        halls.forEach((hall, index) => {
          statsData[hall] = statsResults[index];
        });

        // 渲染統計表格
        renderTotalStats(statsData, selectedDate);
      } catch (err) {
        console.error('Error fetching total stats:', err);
        showToast('獲取統計數據時出錯，請稍後再試', 'danger');
      }
    }

    // 渲染統計總表
    function renderTotalStats(statsData, selectedDate) {
      const statsBody = document.getElementById('total-stats-body');
      statsBody.innerHTML = '';
      const halls = ['hall3', 'hall3E', 'hall62', 'hall71', 'hall82', 'hall103'];
      const options = ['有主日', '答應主日', '有小排', '家聚會(讀經)', '家聚會(讀其他、福音餐廳)', '有聯絡有回應', '有聯絡未回應'];

      // 計算所有會所的總和
      let totalSum = { '總數': 0 };
      options.forEach(option => {
        totalSum[option] = 0;
      });

      halls.forEach(hall => {
        const stats = statsData[hall] || { '總數': 0 };
        options.forEach(option => {
          totalSum[option] += stats[option] || 0;
        });
        totalSum['總數'] += stats['總數'] || 0;
      });

      // 渲染每個會所的數據
      halls.forEach(hall => {
        const hallName = hall.replace('hall', '').replace(/^\d+/, match => {
          return match + '會所';
        });
        const stats = statsData[hall] || { '總數': 0 };
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${hallName}</td>
          <td>${stats['總數'] || 0}</td>
          <td>${stats['有主日'] || 0}</td>
          <td>${stats['答應主日'] || 0}</td>
          <td>${stats['有小排'] || 0}</td>
          <td>${stats['家聚會(讀經)'] || 0}</td>
          <td>${stats['家聚會(讀其他、福音餐廳)'] || 0}</td>
          <td>${stats['有聯絡有回應'] || 0}</td>
          <td>${stats['有聯絡未回應'] || 0}</td>
        `;
        statsBody.appendChild(row);
      });

      // 渲染總和行
      const totalRow = document.createElement('tr');
      totalRow.style.fontWeight = 'bold';
      totalRow.style.backgroundColor = '#e9ecef'; // 可選：添加背景色以區分總和行
      totalRow.innerHTML = `
        <td>總數</td>
        <td>${totalSum['總數']}</td>
        <td>${totalSum['有主日']}</td>
        <td>${totalSum['答應主日']}</td>
        <td>${totalSum['有小排']}</td>
        <td>${totalSum['家聚會(讀經)']}</td>
        <td>${totalSum['家聚會(讀其他、福音餐廳)']}</td>
        <td>${totalSum['有聯絡有回應']}</td>
        <td>${totalSum['有聯絡未回應']}</td>
      `;
      statsBody.appendChild(totalRow);

      document.getElementById('current-date').textContent = formatDateRange(selectedDate);
    }

    // 顯示 Toast
    function showToast(message, type) {
      const toastBody = toastEl.querySelector('.toast-body');
      toastBody.textContent = message;
      toastEl.classList.remove('text-bg-success', 'text-bg-danger');
      toastEl.classList.add(`text-bg-${type}`);
      toast.show();
    }
  </script>
</body>
</html>