<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>統計總表</title>
  <link rel="stylesheet" href="css/main.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
  <div id="navbar-container"></div>

  <div class="container" style="margin-top: 60px;">
    <div class="header-section">
      <h1>各會所統計總表 - <span id="current-date">日期載入中...</span></h1>
    </div>
    <div id="stats-container">
      <h3>統計數據</h3>
      <table id="total-stats-table" class="table table-bordered table-striped table-hover">
        <thead>
          <tr>
            <th>會所</th>
            <th>總數</th>
            <th>有主日(早上)</th>
            <th>聖經講座(晚上)</th>
            <th>有小排</th>
            <th>家聚會(讀經)</th>
            <th>家聚會(讀其他、福音餐廳)</th>
            <th>有聯絡有回應</th>
            <th>有聯絡未回應</th>
          </tr>
        </thead>
        <tbody id="total-stats-body"></tbody>
      </table>
    </div>
  </div>

  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="submit-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto">通知</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // --- 全局變數 ---
    const toastEl = document.getElementById('submit-toast');
    const toast = new bootstrap.Toast(toastEl);
    let dateRanges = []; // 儲存從後端獲取的日期範圍

    // --- 核心函式 ---

    // 顯示 Toast 提示
    function showToast(message, type = 'info') {
      const toastBody = toastEl.querySelector('.toast-body');
      toastBody.textContent = message;
      // 重設背景色 class
      toastEl.classList.remove('text-bg-success', 'text-bg-danger', 'text-bg-warning', 'text-bg-info');
      toastEl.classList.add(`text-bg-${type}`);
      toast.show();
    }
    
    // 載入導航欄
    function loadNavbar() {
      fetch('navbar.html')
        .then(response => response.text())
        .then(data => {
          document.getElementById('navbar-container').innerHTML = data;
          const searchInput = document.getElementById('search-input');
          if (searchInput) {
              searchInput.style.display = 'none'; // 在此頁面隱藏搜尋框
          }
          document.getElementById('date-range').addEventListener('change', function() {
            if(this.value) {
                fetchTotalStats(this.value);
            }
          });
          // 載入 navbar 後立即獲取日期
          fetchAndSetDateRanges();
        })
        .catch(error => {
            console.error('Error loading navbar:', error);
            showToast('導航欄載入失敗', 'danger');
        });
    }

    // 從後端獲取並填充日期範圍
    async function fetchAndSetDateRanges() {
        try {
            const response = await fetch('/getDateRanges');
            if (!response.ok) {
                throw new Error(`伺服器錯誤 (${response.status})`);
            }
            const data = await response.json();
            dateRanges = data.dateRanges || [];

            const dateRangeSelect = document.getElementById('date-range');
            if (dateRangeSelect) {
                populateDateRangeSelect(dateRangeSelect);
                setDefaultDate(dateRangeSelect);
            }
        } catch (error) {
            console.error('Error fetching date ranges:', error);
            showToast('無法載入日期範圍，請檢查伺服器連線', 'danger');
        }
    }

    // 填充日期下拉選單
    function populateDateRangeSelect(selectElement) {
        selectElement.innerHTML = '<option value="" disabled>請選擇日期範圍</option>';
        if (dateRanges.length > 0) {
            dateRanges.forEach((date) => {
                const option = document.createElement('option');
                option.value = date.code;
                option.textContent = date.range;
                selectElement.appendChild(option);
            });
        } else {
            selectElement.innerHTML = '<option value="">無可用日期</option>';
        }
    }

    // 根據當前日期設定預設選項
    function setDefaultDate(selectElement) {
        if (dateRanges.length === 0) return;
        
        const currentDate = new Date();
        let defaultCode = dateRanges[0].code; // 如果找不到匹配，預設為第一個

        for (const range of dateRanges) {
            const [startStr, endStr] = range.range.split('~');
            const currentYear = new Date().getFullYear();
            const startDate = new Date(`${currentYear}/${startStr}`);
            const endDate = new Date(`${currentYear}/${endStr}`);
            endDate.setHours(23, 59, 59, 999);

            if (currentDate >= startDate && currentDate <= endDate) {
                defaultCode = range.code;
                break;
            }
        }
        
        selectElement.value = defaultCode;
        // 觸發一次統計資料的載入
        fetchTotalStats(defaultCode);
    }

    // 獲取並顯示所有會所的統計數據
    async function fetchTotalStats(selectedDate) {
      const halls = ['hall3', 'hall3e', 'hall62', 'hall71', 'hall82', 'hall103'];
      const statsPromises = halls.map(hall => 
        fetch(`/getStats?selectedDate=${selectedDate}&hall=${hall}`)
          .then(response => {
            if (!response.ok) {
              console.error(`Error fetching stats for ${hall}: ${response.statusText}`);
              return {}; // 回傳空物件以避免後續錯誤
            }
            return response.json();
          })
          .catch(error => {
            console.error(`Fetch failed for ${hall}:`, error);
            return {}; // 網路錯誤時也回傳空物件
          })
      );

      try {
        const statsResults = await Promise.all(statsPromises);
        const statsData = {};
        halls.forEach((hall, index) => {
          statsData[hall] = statsResults[index];
        });
        renderTotalStats(statsData, selectedDate);
      } catch (err) {
        console.error('Error processing total stats:', err);
        showToast('處理統計數據時發生錯誤', 'danger');
      }
    }

    // 渲染統計總表
    function renderTotalStats(statsData, selectedDate) {
      const statsBody = document.getElementById('total-stats-body');
      statsBody.innerHTML = '';
      const halls = ['hall3', 'hall3e', 'hall62', 'hall71', 'hall82', 'hall103'];
      const options = ['總數', '有主日(早上)', '聖經講座(晚上)', '有小排', '家聚會(讀經)', '家聚會(讀其他、福音餐廳)', '有聯絡有回應', '有聯絡未回應'];
      
      const hallNameMap = {
        'hall3': '3會所',
        'hall3e': '3會所英語區',
        'hall62': '62會所',
        'hall71': '71會所',
        'hall82': '82會所',
        'hall103': '103會所'
      };

      // 計算總和的物件
      const totalSum = {};
      options.forEach(option => totalSum[option] = 0);

      // 渲染每個會所的數據
      halls.forEach(hall => {
        const hallName = hallNameMap[hall] || hall;
        const stats = statsData[hall] || {};
        const row = document.createElement('tr');
        
        let rowHtml = `<td>${hallName}</td>`;
        options.forEach(option => {
            const count = stats[option] || 0;
            rowHtml += `<td>${count}</td>`;
            totalSum[option] += count; // 累加到總和
        });
        row.innerHTML = rowHtml;
        statsBody.appendChild(row);
      });

      // 渲染總和行
      const totalRow = document.createElement('tr');
      totalRow.style.fontWeight = 'bold';
      totalRow.style.backgroundColor = '#f8f9fa';
      
      let totalRowHtml = `<td>總計</td>`;
      options.forEach(option => {
          totalRowHtml += `<td>${totalSum[option]}</td>`;
      });
      totalRow.innerHTML = totalRowHtml;
      statsBody.appendChild(totalRow);

      const currentDateSpan = document.getElementById('current-date');
      const foundRange = dateRanges.find(r => r.code === selectedDate);
      currentDateSpan.textContent = foundRange ? foundRange.range : '未知日期';
    }

    // --- 頁面初始化 ---
    document.addEventListener('DOMContentLoaded', loadNavbar);
  </script>
</body>
</html>